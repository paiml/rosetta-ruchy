name: Quality Gates

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  test-all-examples:
    name: Test All Ruchy Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Ruchy
        run: |
          cargo install ruchy --version 3.77.0 || cargo install ruchy
          ruchy --version

      - name: Run comprehensive test suite
        run: |
          make test-all-examples
          cat test-results.json

      - name: Check success rate threshold
        run: |
          SUCCESS_RATE=$(jq -r '.summary.success_rate' test-results.json)
          echo "Success Rate: $SUCCESS_RATE"
          if (( $(echo "$SUCCESS_RATE < 0.70" | bc -l) )); then
            echo "❌ Success rate $SUCCESS_RATE is below 70% threshold"
            exit 1
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.json
            INTEGRATION.md
